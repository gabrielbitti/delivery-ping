{% extends "base.html" %}

{% block title %}{{ customer.complete_name }} - DeliveryPing{% endblock %}

{% block content %}
    <div class="page-header">
        <h1>Detalhes do Cliente</h1>
        <div>
            <a href="/web/customers" class="btn btn-secondary">← Voltar</a>
            <a href="/web/customers/{{ customer.id }}/edit" class="btn btn-warning">Editar</a>
        </div>
    </div>

    <div class="card">
        <div class="detail-grid">
            <div class="detail-item">
                <label>ID</label>
                <span>{{ customer.id }}</span>
            </div>

            <div class="detail-item">
                <label>Nome Completo</label>
                <span>{{ customer.complete_name }}</span>
            </div>

            <div class="detail-item">
                <label>Apelido</label>
                <span>{{ customer.nickname or '-' }}</span>
            </div>

            <div class="detail-item">
                <label>Telefone</label>
                <span>{{ customer.cellphone }}</span>
            </div>

            <div class="detail-item">
                <label>CPF</label>
                <span>{{ customer.cpf or '-' }}</span>
            </div>

            <div class="detail-item">
                <label>CNPJ</label>
                <span>{{ customer.cnpj or '-' }}</span>
            </div>

            <div class="detail-item">
                <label>Email</label>
                <span>{{ customer.email or '-' }}</span>
            </div>

            <div class="detail-item">
                <label>WhatsApp</label>
                <span>
                    {% if customer.has_whatsapp %}
                        <span class="badge badge-success">Sim</span>
                    {% else %}
                        <span class="badge badge-secondary">Não</span>
                    {% endif %}
                </span>
            </div>

            <div class="detail-item">
                <label>Status</label>
                <span>
                    {% if customer.is_active %}
                        <span class="badge badge-success">Ativo</span>
                    {% else %}
                        <span class="badge badge-danger">Inativo</span>
                    {% endif %}
                </span>
            </div>

            <div class="detail-item">
                <label>Criado em</label>
                <span>{{ customer.created_at.strftime('%d/%m/%Y %H:%M') if customer.created_at else '-' }}</span>
            </div>

            <div class="detail-item">
                <label>Atualizado em</label>
                <span>{{ customer.updated_at.strftime('%d/%m/%Y %H:%M') if customer.updated_at else '-' }}</span>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>Endereços</h2>
        <div id="addresses-list">
            <div class="addresses-grid">
                {% for address in customer.addresses %}
                    <div class="address-card">
                        <div class="address-header">
                            {% if address.is_primary %}
                                <span class="badge badge-primary">Principal</span>
                            {% else %}
                                <span>&nbsp</span>
                            {% endif %}
                        </div>
                        <p><strong>{{ address.complete_address }}</strong></p>
                        <p>{{ address.city }} - {{ address.state }}</p>
                        <p>CEP: {{ address.zip_code if address.zip_code else '-' }}</p>
                        <p>{{ address.country if address.country else '-' }}</p>
                        <div class="address-actions">
                            <button class="btn btn-sm btn-warning" onclick="editAddress('{{ address.id }}')">Editar</button>
                        </div>
                    </div>
                {% else %}
                    <p>Nenhum endereço cadastrado</p>
                {% endfor %}
            </div>
        </div>
        <button class="btn btn-primary" onclick="showAddressModal()">+ Adicionar Endereço</button>
    </div>

    <div id="addressModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Adicionar Novo Endereço</h3>
                <span class="close" onclick="closeAddressModal()">&times;</span>
            </div>
            <form id="addressForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="complete_address">Endereço Completo *</label>
                        <input type="text" id="complete_address" name="complete_address" class="form-control" 
                               placeholder="Rua, número, complemento" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">Cidade *</label>
                            <input type="text" id="city" name="city" class="form-control" 
                                   placeholder="Nome da cidade" required>
                        </div>

                        <div class="form-group">
                            <label for="state">Estado *</label>
                            <input type="text" id="state" name="state" class="form-control" 
                                   placeholder="Ex: SP, RJ, MG" required maxlength="2">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="zip_code">CEP</label>
                            <input type="text" id="zip_code" name="zip_code" class="form-control" 
                                   placeholder="00000-000" maxlength="9">
                        </div>

                        <div class="form-group">
                            <label for="country">País</label>
                            <input type="text" id="country" name="country" class="form-control" 
                                   placeholder="País" value="Brasil">
                        </div>
                    </div>

                    <div class="form-group checkbox-group">
                        <label>
                            <input type="checkbox" id="is_primary" name="is_primary">
                            Definir como endereço principal
                        </label>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAddressModal()">Cancelar</button>
                    <button type="submit" id="submitButton" class="btn btn-primary">Salvar Endereço</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const customerId = "{{ customer.id }}";
        let currentAddressId = null;
        let isEditMode = false;

        function showAddressModal(addressId = null) {
            isEditMode = !!addressId;
            currentAddressId = addressId;

            const modalTitle = document.getElementById('modalTitle');
            const submitButton = document.getElementById('submitButton');
            
            if (isEditMode) {
                modalTitle.textContent = 'Editar Endereço';
                submitButton.textContent = 'Atualizar Endereço';
                loadAddressData(addressId);
            } else {
                modalTitle.textContent = 'Adicionar Novo Endereço';
                submitButton.textContent = 'Salvar Endereço';
                document.getElementById('addressForm').reset();
                document.getElementById('country').value = 'Brasil';
            }

            document.getElementById('addressModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeAddressModal() {
            document.getElementById('addressModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('addressForm').reset();
            currentAddressId = null;
            isEditMode = false;
        }

        async function loadAddressData(addressId) {
            try {
                const response = await fetch(`/addresses/${addressId}`);
                if (response.ok) {
                    const address = await response.json();
                    
                    // Preencher o formulário com os dados do endereço
                    document.getElementById('complete_address').value = address.complete_address;
                    document.getElementById('city').value = address.city;
                    document.getElementById('state').value = address.state;
                    document.getElementById('zip_code').value = address.zip_code || '';
                    document.getElementById('country').value = address.country || 'Brasil';
                    document.getElementById('is_primary').checked = address.is_primary;
                } else {
                    showToast('Erro ao carregar dados do endereço', 'error');
                    closeAddressModal();
                }
            } catch (error) {
                showToast('Erro ao comunicar com o servidor', 'error');
                closeAddressModal();
            }
        }

        function editAddress(addressId) {
            showAddressModal(addressId);
        }

        window.onclick = function(event) {
            const modal = document.getElementById('addressModal');
            if (event.target === modal) {
                closeAddressModal();
            }
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeAddressModal();
            }
        });

        document.getElementById('addressForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = {
                customer_id: customerId,
                complete_address: formData.get('complete_address'),
                city: formData.get('city'),
                state: formData.get('state').toUpperCase(),
                country: formData.get('country') || 'Brasil',
                zip_code: formData.get('zip_code'),
                is_primary: formData.get('is_primary') === 'on'
            };

            try {
                let response;
                let successMessage;

                if (isEditMode) {
                    response = await fetch(`/addresses/${currentAddressId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    successMessage = 'Endereço atualizado com sucesso!';
                } else {
                    response = await fetch('/addresses', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    successMessage = 'Endereço adicionado com sucesso!';
                }

                if (response.ok) {
                    showToast(successMessage, 'success');
                    closeAddressModal();
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Erro ao salvar endereço', 'error');
                }
            } catch (error) {
                showToast('Erro ao comunicar com o servidor', 'error');
            }
        });

        document.getElementById('zip_code').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 5) {
                value = value.replace(/(\d{5})(\d{1,3})/, '$1-$2');
            }
            e.target.value = value;
        });
    </script>

    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--dark);
            font-size: 1.25rem;
        }

        .close {
            color: var(--secondary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: var(--dark);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .modal-content {
                margin: 10% auto;
                width: 95%;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-footer {
                flex-direction: column;
            }
        }
    </style>
{% endblock %}
